# ğŸ” PortKnock â€”â€” åŸºäº nftables çš„ç«¯å£æ•²é—¨æœåŠ¡

PortKnock æ˜¯ä¸€ä¸ªåŸºäº Linux `nftables` çš„è½»é‡çº§ç«¯å£æ•²é—¨æœåŠ¡ã€‚å®ƒå…è®¸ä½ é€šè¿‡æŒ‡å®šé¡ºåºè®¿é—®ä¸€ç»„â€œæ•²é—¨ç«¯å£â€æ¥ä¸´æ—¶æ”¾è¡ŒæŸä¸ª IP è®¿é—®ç›®æ ‡ç«¯å£ï¼ˆå¦‚ SSHï¼‰ï¼Œä»è€Œå¢å¼ºæœåŠ¡å™¨çš„å®‰å…¨æ€§ã€‚

---

## ğŸ“¦ ç‰¹æ€§

- æ”¯æŒå¤šæœåŠ¡é…ç½®ï¼ˆæ¯ä¸ªæœåŠ¡å¯ç»‘å®šä¸åŒç½‘å¡ï¼‰
- ä½¿ç”¨ `nftables` å®ç°è§„åˆ™ç®¡ç†ï¼Œæ€§èƒ½é«˜ã€å®‰å…¨å¯é 
- æ”¯æŒè‡ªåŠ¨é…ç½®ç”Ÿæˆ
- æ—¥å¿—è®°å½•è¯¦ç»†è¡Œä¸ºï¼Œä¾¿äºå®¡è®¡ä¸è°ƒè¯•
- å¯é€šè¿‡ä¸€é”®è„šæœ¬å®‰è£…éƒ¨ç½²

---

## ğŸ§° å®‰è£…æ–¹å¼ï¼ˆä¸€é”®å®‰è£…ï¼‰

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿå®‰è£…å¹¶è¿è¡Œ PortKnockï¼š

```bash
curl -fsSL https://github.com/AnerYubo/portknock//raw//main/install.sh | bash
```

è¯¥è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š

- ä¸‹è½½é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæˆ–ä»æºç æ„å»ºï¼‰
- åˆ›å»ºç³»ç»ŸæœåŠ¡æ–‡ä»¶ï¼ˆsystemdï¼‰
- åˆ›å»ºé»˜è®¤é…ç½®ç›®å½• `/etc/portknock/`
- å¯åŠ¨å¹¶å¯ç”¨æœåŠ¡ï¼š`systemctl enable --now portknock`

> âš ï¸ æ³¨æ„ï¼šç›®å‰ä½ éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ `/etc/portknock/config.yaml` æ¥é…ç½®æ•²é—¨è§„åˆ™ã€‚

---

## ğŸ› ï¸ é…ç½®è¯´æ˜

PortKnock ä½¿ç”¨ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼š`/etc/portknock/config.yaml`ã€‚

### ç¤ºä¾‹é…ç½®ï¼ˆå·²æ³¨é‡Šï¼Œéœ€æ‰‹åŠ¨å–æ¶ˆæ³¨é‡Šï¼‰ï¼š

```yaml
services:
  - name: "webadmin"
    interface: "eth0"
    knock_ports: [1111, 2222, 3333]
    allow_port: 80
    expire_seconds: 300
    step_timeout_seconds: 5
```

- `name`: æœåŠ¡åç§°ï¼Œç”¨äºæ—¥å¿—æ ‡è¯†
- `interface`: ç»‘å®šçš„ç½‘å¡åï¼ˆå¦‚ eth0ï¼‰
- `knock_ports`: æ•²é—¨ç«¯å£åºåˆ—
- `allow_port`: æ•²é—¨æˆåŠŸåæ”¾è¡Œçš„ç›®æ ‡ç«¯å£
- `expire_seconds`: æˆæƒæŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
- `step_timeout_seconds`: æ¯æ­¥æ•²é—¨æœ€å¤§é—´éš”ï¼ˆç§’ï¼‰

---

## ğŸ“¦ æ‰‹åŠ¨æ„å»ºä¸è¿è¡Œ

å¦‚æœä½ å¸Œæœ›ä»æºç æ„å»ºï¼š

```bash
git clone https://github.com/AnerYubo/portknock.git
cd portknock
go build -o portknock main.go
sudo ./portknock
```

---

## ğŸ“ é»˜è®¤è·¯å¾„è¯´æ˜

| è·¯å¾„ | ç”¨é€” |
|------|------|
| `/etc/portknock/config.yaml` | ä¸»é…ç½®æ–‡ä»¶ |
| `/var/log/portknock/app.log` | é»˜è®¤æ—¥å¿—è¾“å‡ºè·¯å¾„ |
| `/usr/local/bin/portknock` | äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ |
| `/etc/systemd/system/portknock.service` | systemd æœåŠ¡æ–‡ä»¶ |

---

## ğŸ“ ä½¿ç”¨æ–¹å¼ç¤ºä¾‹

å®¢æˆ·ç«¯æ•²é—¨æµç¨‹ï¼ˆä½¿ç”¨ `nc`ï¼‰ï¼š

```bash
nc -zvw 1 yourserver 1111
nc -zvw 1 yourserver 2222
nc -zvw 1 yourserver 3333
```

å¦‚æœæ•²é—¨æˆåŠŸï¼ŒæœåŠ¡ç«¯å°†ä¸´æ—¶æ”¾è¡Œç›®æ ‡ç«¯å£ï¼ˆå¦‚ 80ï¼‰ï¼ŒæŒç»­æ—¶é—´ä¸ºé…ç½®ä¸­çš„ `expire_seconds`ã€‚

---

## ğŸ§ª æ—¥å¿—æŸ¥çœ‹

æœåŠ¡è¿è¡Œåå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
journalctl -u portknock -f
```

æˆ–è€…æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š

```bash
cat /var/log/portknock/app.log
```

---

## ğŸ“Œ å·²çŸ¥é—®é¢˜ & æ³¨æ„äº‹é¡¹

- å½“å‰ç‰ˆæœ¬åªæ”¯æŒ TCP SYN åŒ…è¯†åˆ«ï¼ŒSYN åŒ…é‡ä¼ å¯èƒ½å¯¼è‡´å¤šæ¬¡è§¦å‘æ•²é—¨æµç¨‹ã€‚
- ä¸åŒæœåŠ¡ç›‘å¬ç›¸åŒç½‘å¡æ—¶ï¼Œéœ€è¦é¿å…ç«¯å£å†²çªã€‚
- åˆå§‹é…ç½®æ–‡ä»¶ä¸­æœåŠ¡æ˜¯è¢«æ³¨é‡Šçš„ï¼Œè¯·åŠ¡å¿…å–æ¶ˆæ³¨é‡Šåå†è¿è¡Œç¨‹åºã€‚

---

## ğŸ¤ è´¡çŒ®ä»£ç 

æ¬¢è¿æäº¤ PR å’Œ issueï¼š

- æŠ¥å‘Š bug
- æå‡ºæ–°ç‰¹æ€§å»ºè®®ï¼ˆå¦‚æ”¯æŒ UDP æ•²é—¨ã€HTTP API æŸ¥è¯¢çŠ¶æ€ç­‰ï¼‰
- ç¼–å†™æ–‡æ¡£å’Œæµ‹è¯•ç”¨ä¾‹

---

## ğŸ“„ License

MIT License

---

## ğŸ’¬ è”ç³»ä½œè€…

GitHub: [@AnerYubo](https://github.com/AnerYubo)

---
